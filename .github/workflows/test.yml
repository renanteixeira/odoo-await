name: Test Suite

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test-multi-version:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        odoo-version: ['12.0', '13.0', '14.0', '15.0', '16.0', '17.0', '18.0', '19.0']
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Start Odoo ${{ matrix.odoo-version }} environment
      run: |
        version="${{ matrix.odoo-version }}"
        version_num="${version%.*}"
        
        echo "Starting only Odoo ${version} environment..."
        
        # Start PostgreSQL and wkhtmltopdf
        docker compose up -d postgres wkhtml
        
        # Wait for PostgreSQL
        echo "Waiting for PostgreSQL..."
        timeout 60 bash -c "until docker compose exec postgres pg_isready -U postgres >/dev/null 2>&1; do sleep 2; done"
        
        # Create database and user if needed
        docker compose exec postgres psql -U postgres -c "SELECT 1 FROM pg_roles WHERE rolname='odoo'" | grep -q 1 || {
          docker compose exec postgres psql -U postgres -c "CREATE USER odoo WITH CREATEDB PASSWORD 'odoo';"
        }
        
        # Create database if it doesn't exist
        docker compose exec postgres psql -U postgres -lqt | cut -d \| -f 1 | grep -qw "odoo${version_num}" || {
          docker compose exec postgres createdb -U postgres -O odoo odoo${version_num}
        }
        
        # Initialize Odoo with base module
        docker compose run --rm odoo${version_num} odoo \
          --database=odoo${version_num} \
          --db_user=odoo \
          --db_password=odoo \
          --db_host=postgres \
          --init=base \
          --stop-after-init \
          --without-demo=False
        
        # Start only the specific Odoo service
        docker compose up -d odoo${version_num}

    - name: Wait for services to be ready
      run: |
        version="${{ matrix.odoo-version }}"
        version_num="${version%.*}"
        port="${version_num}069"
        
        echo "Waiting for Odoo ${version} on port $port..."
        timeout 120 bash -c "until curl -s http://localhost:$port > /dev/null; do sleep 5; done"

    - name: Test Odoo ${{ matrix.odoo-version }}
      run: |
        version="${{ matrix.odoo-version }}"
        version_num="${version%.*}"
        port="${version_num}069"
        
        echo "Testing Odoo $version on port $port"
        ODOO_DB="odoo${version_num}" \
        ODOO_USER="admin" \
        ODOO_PW="admin" \
        ODOO_BASE_URL="http://localhost:${port}" \
        npm test

    - name: Check services status
      if: always()
      run: ./manage-odoo.sh status

  test-all-versions:
    runs-on: ubuntu-latest
    needs: test-multi-version

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Initialize multi-version environment
      run: |
        chmod +x ./manage-odoo.sh
        chmod +x ./init-all-odoo.sh
        chmod +x ./test-all-versions.sh
        
        # Check if services are already running (from previous jobs)
        if docker compose ps | grep -q "odoo"; then
          echo "Services already running, skipping initialization..."
        else
          echo "Initializing multi-version environment..."
          ./manage-odoo.sh init
        fi

    - name: Wait for all services to be ready
      run: |
        echo "Waiting for all Odoo services to be ready..."
        for version in 12 13 14 15 16 17 18 19; do
          port=$((${version}069))
          echo "Waiting for Odoo ${version}.0 on port $port..."
          timeout 180 bash -c "until curl -s http://localhost:$port > /dev/null; do sleep 5; done" || {
            echo "Error: Odoo ${version}.0 failed to respond on port $port"
            exit 1
          }
        done
        echo "All Odoo services are ready!"

    - name: Run comprehensive test suite
      run: |
        echo "Starting comprehensive test suite..."
        ./test-all-versions.sh || {
          echo "Some tests failed, but continuing to generate report..."
          ./manage-odoo.sh status
          exit 1
        }

    - name: Generate test report
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Multi-version Odoo testing completed" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Versions tested: 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0" >> $GITHUB_STEP_SUMMARY
        ./manage-odoo.sh status
